name: Deploy Buddy Moltworker

on:
  workflow_dispatch:
    inputs:
      buddy_name:
        description: 'Buddy name (e.g., roel-buddy-emrys)'
        required: true
        type: string
      telegram_bot_token:
        description: 'Telegram Bot Token (from @BotFather)'
        required: true
        type: string

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout mybuddyswarm
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clone Moltworker base
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh repo clone cloudflare/moltworker moltworker-base -- --depth 1

      - name: Install dependencies
        working-directory: moltworker-base
        run: npm install

      - name: Configure buddy
        run: |
          cd moltworker-base
          
          # Update wrangler.jsonc with buddy name
          sed -i 's/"name": "moltbot-sandbox"/"name": "${{ inputs.buddy_name }}"/' wrangler.jsonc
          sed -i 's/"bucket_name": "moltbot-data"/"bucket_name": "${{ inputs.buddy_name }}-data"/' wrangler.jsonc
          
          # Create correct moltbot.json.template with identity
          cat > moltbot.json.template << 'EOF'
          {
            "agents": {
              "defaults": {
                "workspace": "/root/clawd",
                "model": {
                  "primary": "anthropic/claude-sonnet-4-20250514",
                  "fallbacks": ["anthropic/claude-3-5-haiku-20241022"]
                }
              },
              "list": [
                {
                  "id": "main",
                  "identity": {
                    "name": "Emrys",
                    "theme": "wise and curious companion",
                    "emoji": "ü¶â"
                  }
                }
              ]
            },
            "channels": {
              "telegram": {
                "enabled": true,
                "dmPolicy": "allowlist",
                "allowFrom": ["tg:6528670828", "*"]
              }
            },
            "gateway": {
              "port": 18789,
              "mode": "local"
            }
          }
          EOF
          
          # Create workspace sync script (runs at container startup)
          cat > sync-workspace.sh << 'SYNCEOF'
          #!/bin/bash
          # Sync workspace files from R2 backup to container workspace
          BACKUP_DIR="/data/moltbot"
          WORKSPACE="/root/clawd"
          
          # Restore workspace files from R2 if they exist
          if [ -d "$BACKUP_DIR/workspace" ]; then
            echo "Restoring workspace files from R2..."
            cp -a "$BACKUP_DIR/workspace/." "$WORKSPACE/" 2>/dev/null || true
            echo "Workspace restored: $(ls -la $WORKSPACE/*.md 2>/dev/null | wc -l) files"
          else
            echo "No workspace backup in R2 yet"
          fi
          SYNCEOF
          chmod +x sync-workspace.sh
          
          # Add sync script to Dockerfile and call it from start-moltbot.sh
          echo "" >> Dockerfile
          echo "# Add workspace sync script" >> Dockerfile
          echo "COPY sync-workspace.sh /usr/local/bin/sync-workspace.sh" >> Dockerfile
          echo "RUN chmod +x /usr/local/bin/sync-workspace.sh" >> Dockerfile
          
          # Patch start-moltbot.sh to call workspace sync
          sed -i '/^echo "Starting Moltbot Gateway..."/i # Sync workspace from R2\n/usr/local/bin/sync-workspace.sh\n' start-moltbot.sh || true

      - name: Create R2 bucket
        run: |
          cd moltworker-base
          npx wrangler r2 bucket create ${{ inputs.buddy_name }}-data || echo "Bucket may already exist"

      - name: Set secrets
        run: |
          cd moltworker-base
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | npx wrangler secret put ANTHROPIC_API_KEY
          echo "${{ inputs.telegram_bot_token }}" | npx wrangler secret put TELEGRAM_BOT_TOKEN
          echo "${{ secrets.MOLTBOT_GATEWAY_TOKEN }}" | npx wrangler secret put MOLTBOT_GATEWAY_TOKEN
          echo "true" | npx wrangler secret put DEV_MODE
          echo "${{ secrets.R2_ACCESS_KEY_ID }}" | npx wrangler secret put R2_ACCESS_KEY_ID
          echo "${{ secrets.R2_SECRET_ACCESS_KEY }}" | npx wrangler secret put R2_SECRET_ACCESS_KEY
          echo "${{ env.CLOUDFLARE_ACCOUNT_ID }}" | npx wrangler secret put CF_ACCOUNT_ID

      - name: Deploy to Cloudflare
        run: |
          cd moltworker-base
          npx wrangler deploy

      - name: Output URLs
        run: |
          echo "‚úÖ Buddy deployed!"
          echo "üåê Control UI: https://${{ inputs.buddy_name }}.viriya.workers.dev"
          echo "ü§ñ Telegram: Ready to chat!"
